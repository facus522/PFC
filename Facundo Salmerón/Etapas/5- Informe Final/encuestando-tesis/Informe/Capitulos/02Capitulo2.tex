%---------------------------------------------------------------------
%
%                          Capítulo 4
%
%---------------------------------------------------------------------
\lstset{
	escapeinside={<@}{@>},
	frame = single, 
	language=Java}
\definecolor{mygray}{RGB}{118, 118, 118}
\definecolor{myblue}{RGB}{27, 6, 215}
\definecolor{mypurple}{RGB}{128, 75, 119}
\def\graycolor{\color{mygray}}
\def\blackcolor{\color{black}}
\def\bluecolor{\color{myblue}}
\def\purplecolor{\color{mypurple}}

\chapter{Diseño y desarrollo de la aplicación móvil}

\begin{resumen}
	En este capítulo se describen todos los aspectos relacionados al diseño y desarrollo de la aplicación en cuestión. Se desarrollará un análisis de Android, en el cual se describirán todas las características y estructura del proyecto.
	\\
	Se presentará el desarrollo realizado para llevar adelante la solución del problema principal, junto a todas las APIs y bibliotecas utilizadas en conjunto.
\end{resumen}


%-------------------------------------------------------------------
\section{Proyecto Android}
%-------------------------------------------------------------------
\label{cap4:sec:nociones-android}

Tal como fue especificado anteriormente, el desarrollo de la aplicación móvil fue llevado a cabo bajo el IDE Android Studio. Para ello, es importante describir todas las cuestiones relacionadas a un proyecto Android, con la finalidad de comprender la estructura que el mismo presenta, todos los componentes básicos, ciclos de vida, comunicación con el Web Service, entre otras cosas.

%------------------------------------------------------------------
\subsection{Componentes básicos de una aplicación Android}
%-------------------------------------------------------------------
\label{cap4:subsec:componentes-android}

Es de suma importancia comprender cuáles son los distintos componentes que se pueden encontrar en una aplicación Android típica, para luego tener un mejor análisis de la estructura que conlleva un proyecto de dicho lenguaje.
\\

Los componentes de la aplicación son bloques de creación esenciales de una aplicación para Android. Cada componente es un punto diferente a través del cual el sistema puede ingresar a la aplicación. No todos los componentes son puntos de entrada reales para el usuario y algunos son dependientes entre sí, pero cada uno existe como entidad individual y cumple un rol específico; cada uno es un bloque de creación único que ayuda a definir el comportamiento general de tu aplicación \cite{componentesAndroid}.
\\

Hay cuatro tipos diferentes de componentes de una aplicación. Cada tipo tiene un fin específico y un ciclo de vida diferente que define cómo se crea y se destruye el componente:

\begin{itemize}
	
	\item \textbf{\textit{Activities}}: una activity representa una pantalla con interfaz de usuario. Cada una de ellas tiene asignada una ventana en la cual se representa la interfaz gráfica. Para llevar adelante la construcción de la interfaz, existen componentes denominados vistas (Views) con los que se dispone de numerosos controles básicos, como por ejemplo botones, cuadros de texto, imágenes, etc.
	
	Una aplicación está formada por diversos activities, los cuales se encuentran interactuando entre sí. Existe una actividad principal (definida en el manifest como se verá más adelante), que se encarga de iniciar la aplicación.
	
	Para crear una nueva actividad, se debe crear una nueva clase Java, que hereda de \textit{Activity}, definiendo así su propia interfaz de usuario y las funcionalidades pertinentes.
	
	\item \textbf{\textit{Services}}: un servicio es un componente que se ejecuta en segundo plano para realizar operaciones prolongadas o tareas para procesos remotos. Un servicio no proporciona una interfaz de usuario. Son llamados a través de otro componente, como puede ser una Activity, y seguirán ejecutándose en segundo plano aunque la misma haya finalizado
	
	\item \textbf{\textit{Content Providers}}: es un componente destinado a compartir datos entre aplicaciones. Dichos datos pueden ser almacenados en el sistema de archivos, en una base de datos SQLite o en cualquier otro lugar que sea accesible desde la aplicación.
	
	\item \textbf{\textit{Broadcast Receiver}}: es un componente que detecta y reacciona frente a mensajes globales del sistema, como puede ser batería baja, SMS recibido, llamada perdida, etc. Además de esto, las aplicaciones también pueden iniciar mensajes; por ejemplo, para permitir que otras aplicaciones sepan que se descargaron datos al dispositivo y están disponibles para usarlos. Si bien no exhiben una interfaz de usuario, pueden crear una notificación de la barra de estado para alertar al usuario cuando se produzca un evento de mensaje.
	
\end{itemize}


%------------------------------------------------------------------
\subsection{Estructura del proyecto}
%-------------------------------------------------------------------
\label{cap4:subsec:estructura-android}

Un proyecto desarrollado en Android Studio está formado por distintos directorios, los cuales contienen recursos que se utilizarán a medida que se va desarrollando la aplicación. Dentro de las características principales que posee, se realiza una modularización en directorios y utiliza el lenguaje de programación XML, evitando de esta forma el exceso de código inútil en los ficheros Java.
\\

Tal como se puede ver en la Figura \ref{fig:estructura_proyecto}, inicialmente nos encontramos con un archivo de configuración XML denominado \textit{AndroidManifest}. Se encuentra situado en la raíz de todos los proyectos, y sirve para aplicar configuraciones básicas en la aplicación. El sistema Android accede a él antes de compilar cualquier línea de código \cite{manifest}. Dentro de las configuraciones que contiene se destacan:

\begin{itemize}
	
	\item Nombre del paquete de la aplicación, para identificarla de manera única.
	
	\item Definición de componentes como Activities, Services, Content, Providers, etc.
	
	\item Activity principal al iniciar.
	
	\item Nivel mínimo del API que Android requiere para la aplicación.
	
	\item Nombre e ícono de la aplicación.
	
	\item Permisos que necesita la app para realizar determinadas tareas. Como por ejemplo acceder a la ubicación, internet, etc.
	
\end{itemize}

\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=1\textwidth]%
		{Imagenes/Bitmap/estructuraAndroid}
		\caption{Estructura de proyecto Android}
		\label{fig:estructura_proyecto}
	\end{center}
\end{figure}

A continuación del manifest se sitúa el directorio \textit{Java}. Esta carpeta, que a su vez puede ser subdividida en distintos paquetes y subdirectorios, contiene todo el código fuente de la aplicación, activities, clases auxiliares, enumerables, interfaces, tests unitarios, etc. Inicialmente, Android Studio crea automáticamente el código básico de la pantalla principal de la aplicación, es decir el \textit{MainActivity}, que se ejecuta cuando la aplicación inicia.
\\

Luego nos encontramos con el directorio \textit{res}, es decir los recursos. Como lo dice su nombre, contiene todos los ficheros de recursos necesarios para el proyecto como imágenes, layouts, cadenas de texto, etc. Al igual que en el caso anterior, es subdividido en distintos subdirectorios, en los que se destacan los siguientes \cite{estructuraAndroid}:

\begin{itemize}
	
	\item \textbf{\textit{Drawable}}: contiene todas las imágenes y elementos gráficos utilizados por la aplicación. Para poder definir diferentes recursos dependiendo de la resolución y densidad de la pantalla del dispositivo, se encuentran varios directorios dentro de drawable.
	
	\item \textbf{\textit{Mipmap}}: contiene los íconos de la aplicación y al igual que en el caso anterior, se divide en subdirectorios de acuerdo a la resolución y densidad de pantalla. 
	
	\item \textbf{\textit{Layout}}: contiene los archivos XML relacionados a los Activities Java para la definición de la interfaz gráfica. En dichos contenedores se puede definir la estructura básica de una pantalla y agregar componentes de interacción con el usuario como ser botones, menú desplegable, campos de texto, entre otros. 
	
	De todas formas, solo es necesario definir el contenedor layout, ya que que dichos componentes también pueden ser agregados dinámicamente en los Activities (programáticamente en Java).
	
	Cada Activity se relaciona con un layout y mediante el método \textit{onCreate()} se levanta dicho archivo y se genera la pantalla, pudiendo acceder a los componentes de la misma para setear funcionalidades extra. Por ejemplo, así como dijimos que existe un \textit{MainActivity}, existe un \textit{activity\_main.xml} que es el layout asociado a esa Activity. 
	
	Cada componente posee un id, por lo tanto si se quisiera referenciar alguno de ellos para manipularlo, simplemente se debería invocarlo con el mismo.
	
	\item \textbf{\textit{Values}}: contiene otros archivos XML de importancia para la aplicación en los que se pueden definir todo tipo de valores, como por ejemplo cadenas de texto (\textit{strings.xml}), estilos (\textit{styles.xml}), colores (\textit{colours.xml}), etc. Estos valores luego pueden ser llamados desde cualquier punto de la aplicación, utilizando siempre el mismo recurso, sin necesidad de volver a redefinirlo cada vez que se lo requiera. Y si se desea realizar un cambio sobre alguno de ellos, simplemente se modifica el recurso de la carpeta value y el cambio se replica en toda la aplicación.
	
	Por ejemplo, en la aplicación del proyecto se definió un estándar para un tipo de botón. Por lo tanto en el archivo \textit{colours.xml} se definió:
	\\
	\begin{lstlisting}[escapechar=¿]
		<color ¿\aftergroup\purplecolor¿name¿\aftergroup\blackcolor¿=¿\aftergroup\bluecolor¿"mainButtonColor"¿\aftergroup\blackcolor¿>¿\aftergroup\graycolor¿#3646c1¿\aftergroup\blackcolor¿</color>
	\end{lstlisting}
	
	Entonces, cada vez que se requería colocar dicho color en un botón de la aplicación (o donde fuera necesario), simplemente se llamaba por su nombre y se aplicaba.
\end{itemize}

Finalmente se encuentran los parámetros de configuración de Gradle. Gradle básicamente es una herramienta de automatización para la construcción del proyecto, similar a Maven (herramienta utilizada en el desarrollo del Web Service). En dichos archivos, se encuentra la información necesaria para la compilación del proyecto, por ejemplo la versión del SDK de Android utilizada para compilar, la mínima versión de Android que soportará la aplicación, referencias a librerías externas utilizadas, el número de versión de la app, etc.
\\

En un proyecto pueden existir varios ficheros build.gradle, para definir determinados parámetros a distintos niveles. En este caso, podemos ver que existe un fichero build.gradle a nivel de proyecto, y otro a nivel de módulo dentro de la carpeta /app. El primero de ellos definirá parámetros globales a todos los módulos del proyecto, y el segundo sólo tendrá efecto para cada módulo en particular.
\\

Como se puede ver en la Figura \ref{fig:conf-sdk}, se establece la primer versión de la aplicación móvil, junto con la definición del SDK Android utilizado para compilar en la versión 26, correspondiente con Android 7.0 Nogaut. La versión mínima de SDK que soportará será la 19, tal como se mencionó anteriormente, se corresponde con Android 4.4 KitKat.

\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=1\textwidth]%
		{Imagenes/Bitmap/gradle1}
		\caption{Configuración SDK}
		\label{fig:conf-sdk}
	\end{center}
\end{figure}

A su vez, como se visualiza en la Figura \ref{fig:conf-librerias}, se encuentran todas las dependencias correspondientes a librerías externas, que se encargan de complementar el proyecto y lograr el alcance esperado. Por ejemplo, se encuentran las dependencias relacionadas para el API de Google Maps, Firebase, OpenCsv, etc.

\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=1\textwidth]%
		{Imagenes/Bitmap/gradle2}
		\caption{Librerías externas utilizadas}
		\label{fig:conf-librerias}
	\end{center}
\end{figure}

%------------------------------------------------------------------
\subsection{Actividades y ciclo de vida de una aplicación}
%-------------------------------------------------------------------
\label{cap4:subsec:ciclovida}

Todas las aplicaciones Android corren dentro de su propio proceso, el cual es creado junto a la aplicación y el sistema operativo es el encargado de eliminarlo cuando lo cree necesario, como por ejemplo para liberar su memoria. Tal como se puede ver, en Android el tiempo de vida de las aplicaciones se encuentra controlado por el sistema operativo y no por el usuario.
\\

Tal como se mencionó en secciones posteriores, las actividades se gestionan mediante métodos implementados en los Activity. Una aplicación contiene múltiples actividades vinculadas entre sí, donde una de ellas es especificada como principal dentro del \textit{AndroidManifest.xml}. Es decir, cuando la aplicación inicie esta será la pantalla que el usuario verá. 
\\

Cuando se inicia un Activity se coloca en el tope de una pila que contiene todas las actividades de la aplicación (``pila de actividades''), haciendo que la anterior se detenga pero sin perder sus datos. El ciclo de vida de una actividad se ve directamente afectado por su asociación con otras actividades, con sus tareas y con la pila de actividades. Tal como funcionan las pilas (mecanismo LIFO - ``Last in first out''), la última actividad en entrar será la primera en salir, por lo tanto cuando el usuario termina de interactuar con la actividad actual y presiona el botón ``Atrás'', la misma es destruida de la pila y es reanudada la actividad anterior \cite{cicloVida}.
\\

Una actividad puede existir básicamente en tres estados:

\begin{itemize}
	
	\item \textbf{\textit{Reanudada}}: La actividad se encuentra en el primer plano de la pantalla y tiene la atención del usuario. También denominada ``En Ejecución''.
	
	\item \textbf{\textit{Pausada}}: Otra actividad se encuentra en el primer plano y tiene la atención del usuario, pero esta todavía está visible. Es decir, otra actividad está por encima de esta y esa actividad es parcialmente transparente o no cubre toda la pantalla. El objeto Activity pausado se conserva en la memoria, mantiene toda la información de estado y miembro y continúa anexado al administrador de ventanas, pero el sistema puede eliminarla en situaciones en que la memoria sea extremadamente baja.
	
	\item \textbf{\textit{Detenida}}: La actividad está completamente opacada por otra actividad (ahora la actividad se encuentra en ``segundo plano''). En este caso, el objeto Activity también se conserva en memoria, mantiene toda la información de estado y miembro, pero no está anexado al administrador de ventanas. Sin embargo, ya no está visible para el usuario y el sistema puede eliminarla cuando necesite memoria en alguna otra parte.
	 
\end{itemize}

Cuando una actividad entra y sale de los diferentes estados mencionados, se notifica a través de diferentes métodos callbacks. En conjunto, estos métodos definen el ciclo de vida completo de una actividad, como se puede observar en la Figura \ref{fig:cicloVida}. Los métodos mencionados en dicha figura se explican a continuación:

\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=1\textwidth]%
		{Imagenes/Bitmap/cicloVida}
		\caption{Ciclo de vida de una actividad}
		\label{fig:cicloVida}
	\end{center}
\end{figure}

\begin{itemize}
	
	\item \textbf{\textit{onCreate}}: Recibe una llamada cuando se crea la actividad por primera vez. Siempre seguido por \textit{onStart}.
	
	\item \textbf{\textit{onRestart}}: Recibe una llamada después de que se detiene la actividad, junto antes de que vuelva a iniciarse. Siempre seguido por \textit{onStart}.
	
	\item \textbf{\textit{onStart}}: Recibe una llamada justo antes de que la actividad se vuelva visible para el usuario. Seguido por \textit{onResume} si la actividad pasa a primer plano, o por \textit{onStop}.
	
	\item \textbf{\textit{onResume}}: Recibe una llamada justo antes de que la actividad comience a interactuar con el usuario. En este momento la actividad se encuentra en la parte superior de la pila de actividades, y recibe las entradas del usuario. Siempre seguido por \textit{onPause}.
	
	\item \textbf{\textit{onPause}}: Recibe una llamada cuando el sistema está a punto de reanudar otra actividad. Seguido por \textit{onResume} si la actividad vuelve al primer plano, o por \textit{onStop} si se vuelve invisible para el usuario.
	
	\item \textbf{\textit{onStop}}: Recibe una llamada cuando la actividad ya no es visible para el usuario. Esto puede ocurrir porque se la destruyó o porque se reanudó otra actividad (ya sea una actividad existente o una nueva) y la está cubriendo. Seguido por \textit{onRestart} si la actividad vuelve a interactuar con el usuario, o por \textit{onDestroy} si la actividad desaparece.
	
	\item \textbf{\textit{onDestroy}}: Recibe una llamada antes de que se destruya la actividad. Esta es la última llamada que recibirá la actividad. Se lo puede llamar porque la actividad está finalizando (alguien llamó a finish() para esa actividad), o porque el sistema destruye temporalmente esa instancia de la actividad para ahorrar espacio.
	
\end{itemize}

%------------------------------------------------------------------
\subsection{Conexión Web Service - Aplicación}
%-------------------------------------------------------------------
\label{cap4:subsec:comunicacionwsapp}

Para llevar adelante la comunicación entre la aplicación Android y el Web Service Java, se utilizó la librería \textit{HttpComponents} de la fundación Apache, la cual es agregada al proyecto con la herramienta Gradle, como todas las dependencias externas.
\\

Es un un conjunto de herramientas de componentes Java de bajo nivel centrado en HTTP y los protocolos asociados \cite{conexionws}. Brindan servicios del tipo cliente-servidor con un mínimo nivel de abstracción ya que muchas cuestiones básicas están resueltas, HttpClient y HttpCore (el primero de ellos de interés para nuestro proyecto).
\\

Aunque el paquete de java.net proporciona la funcionalidad básica para los recursos que tienen acceso vía HTTP, no proporciona flexibilidad o funcionalidad completa necesitada por muchos usos \cite{httpComponents}. En cambio, el componente HttpComponents proporciona abundantes características que pone el lado del cliente en ejecución de los estándares más recientes y de las recomendaciones del HTTP.
\\

A partir de una URL válida (visto en la sección de servicios disponibles del Web Service), la librería establece una conexión asíncrona con el servidor, esto quiere decir que las solicitudes HTTP suceden fuera del hilo de la interfaz de usuario y su respuesta se procesa una vez que llega al dispositivo en segundo plano. Esto es importante ya que no bloquea la pantalla ni la interacción con la misma.

%------------------------------------------------------------------
\subsection{Interfaz de usuario}
%-------------------------------------------------------------------
\label{cap4:subsec:interfaz-usuario}

La interfaz de usuario (UI) es una parte fundamental de las aplicaciones Android. Es el conjunto de elementos que permiten al usuario comunicarse e interaccionar con la app.  Al igual que cualquier otro componente, la UI puede ser definida en XML y levantada por el MainActivity.
\\

Android Studio brinda la posibilidad de desarrollar aplicaciones en base a plantillas predefinidas, como por ejemplo pantallas de login, pantallas fullscreen, scrolleables, mapas, etc. A las cuales se les pueden agregar distintos controles de selección ofrecidos por el IDE, ya sea para mostrar o interactuar con la información, como pueden ser listas, tablas, checks, botones, listas desplegables, galerías, etc.
\\

Además, tal como fue mencionado anteriormente, cada vez que se desee crear una nueva pantalla se generará el archivo \textit{.xml} y el Activity \textit{.Java}, ambos relacionados. Para llevar adelante el diseño de la misma, Android Studio brinda la posibilidad de realizarlo mediante código xml y presentando una ventana de actualización automática \textit{Preview} para ir verificando visualmente lo realizado. O puede diseñarse mediante un panel de construcción, donde es posible ir arrastrando y ubicando manualmente los componentes a utilizar, lo cual es mucho más sencillo.

%-------------------------------------------------------------------
\section{Geo posicionamiento}
%-------------------------------------------------------------------
\label{cap4:sec:geoposicionamiento}

Para todas aquellas encuestas que sean del tipo ``Geolocalizadas'', cuando el usuario de resolución se encuentra en su residencia habitual, es necesario obtener los datos de su ubicación mediante el componente GPS del dispositivo móvil. Inicialmente es necesario que el usuario acepte los permisos que se presentarán para la utilización del mismo.
\\

Para ello se utilizó la funcionalidad \textit{LocationServices}, brindada por Google Services \cite{locationservice}. Esta se encarga de monitorear la posición del móvil a través del sensor GPS y la conexión a redes. Al momento de responder la encuesta tiene que estar activado el sensor y los permisos aceptados, donde finalmente se podrán obtener los datos en relación a la localización, principalmente la latitud y longitud que serán persistidos.

%-------------------------------------------------------------------
\section{Servicios externos}
%-------------------------------------------------------------------
\label{cap4:sec:servicios-externas}

Para llevar adelante todas las peticiones establecidas en el proyecto, fue necesaria la integración de distintos componentes encargados de complementar todos los servicios prestados por el IDE Android Studio. 
\\

De esta forma, las distintas librerías y/o APIs utilizadas fueron anotadas en el \textit{build.gradle}, tal como se mencionó previamente. Obteniendo de esta forma la resolución de distintas cuestiones relacionadas al proyecto, sin tener que desarrollar manualmente cada una de ellas, lo cual incrementaría el tiempo de trabajo.
\\

En la ésta sección se hará una presentación más amplia sobre cada una de ellas, en relación a lo presentado en la Sección \ref{cap2:subsec:apis}.

%------------------------------------------------------------------
\subsection{API Firebase}
%-------------------------------------------------------------------
\label{cap4:subsec:firebase}

Firebase es una plataforma móvil creada por Google, cuya principal función es desarrollar y facilitar la creación de aplicaciones de alta calidad, con la finalidad de poder aumentar la cantidad de usuarios e ingresos de dinero \cite{firebase1}. Se encuentra subida en la nube y esta disponible para diferentes plataformas como iOS, Android y web.
\\

Dentro de las principales características que posee, en cuanto al desarrollo podemos mencionar que permite la creación de mejores aplicaciones, minimizando el tiempo de optimización y desarrollo, mediante diferentes funciones, entre las que destacan la detección de errores y de testeo. Además, permite almacenar todo en la nube, testear la app o poder configurarla de manera remota.
\\

Desde el punto de vista analítico, permite llevar un control de rendimiento de la aplicación mediante distintas métricas, ofrecidas en un panel web de forma gratuita. Estos datos analíticos que ofrece Firebase, facilitan la toma de decisiones basadas y fundamentadas en datos reales \cite{firebase3}.
\\

Como se puede ver, ésta API presenta una gran variedad de servicios que facilitan el desarrollo de aplicaciones móviles. Entre las más destacadas se presentan las siguientes \cite{firebase2}:

\begin{itemize}
	
	\item Base de datos Realtime.
	
	\item Autenticación con redes sociales.
	
	\item Almacenamiento.
	
	\item Hosting.
	
	\item Testing para Android.
	
	\item Notificaciones.
	
	\item Informes sobre fallos.
	
	\item Monitoreo de rendimientos.
	
\end{itemize}

Dentro de las funcionalidades ofrecidas, la de notificaciones fue de interés en este proyecto. Para ello, Firebase presenta de manera muy sencilla un servicio de mensajería, donde a la hora de enviar notificaciones, el administrador de la aplicación debe ingresar a la web de desarrollo \textit{https://console.firebase.google.com} y configurar la misma. 
\\

Luego, en la sección \textit{Cloud Messaging} como se puede ver en la Figura \ref{fig:notifirebase}, se le debe dar el formato a la notificación colocando un título y una descripción, entre otras configuraciones opcionales. Finalmente, la misma es enviada de forma inmediata hacia todos los dispositivos que tengan instalada la aplicación. 

\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=1\textwidth]%
		{Imagenes/Bitmap/notifirebase}
		\caption{Envío de notificación con API Firebase}
		\label{fig:notifirebase}
	\end{center}
\end{figure}

Además, se puede configurar el envío de notificaciones hacia determinados dispositivos, programar horarios y enviarlas de manera automática.

%------------------------------------------------------------------
\subsection{API Google Maps y Picker}
%-------------------------------------------------------------------
\label{cap4:subsec:googleapi}

Google provee una serie de servicios de gran utildad para llevar adelante el desarrollo de aplicaciones Android. Para poder acceder a las distintas herramientas como pueden ser Google Maps y Picker, se debe contar con una key provista por Google. Esta es una cadena de caracteres alfanuméricos provista a un desarrollador para poder incluirlas en sus productos.
\\

Para poder utilizar ambas APIs en Android, es necesario definir en el \textit{AndroidManifest.xml} la API Key obtenida y la versión de Google Play Services que se está utilizando. Además, se debe agregar un permiso para recibir mapas a través de Internet.
\\

El API Picker, presenta un SDK para Android denominado \textit{Place Picker} (selector de lugares) \cite{picker}. Es un widget simple y flexible, que presenta mediante interfaz de usuario un mapa interactivo y una lista de lugares cercanos. Los usuarios pueden elegir una ubicación presionando sobre el mapa, lo cual creará un marcador y el API se encargará de recuperar los detalles del mismo, como dirección, latitud, longitud, etc (Figura \ref{fig:placepicker}). A su vez, tiene integrada una barra de búsqueda que permite ingresar manualmente una dirección y el API se encarga de localizarla en el mapa y colocar un marcador sobre ella.
\\

Los \textit{markers} (marcadores), indican ubicaciones únicas en el mapa y se posicionan a partir de la latitud y longitud. Los mismos pueden contener un título e imágenes. 

\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=0.35\textwidth]%
		{Imagenes/Bitmap/placepicker}
		\caption{Selección de ubicación en Place Picker}
		\label{fig:placepicker}
	\end{center}
\end{figure}

Esta funcionalidad es de utilidad en el proyecto, ya que las encuestas tendrán la posibilidad de ser geolocalizadas. Cuando los usuarios al responder las mismas se encuentran en sus residencias habituales, mediante los servicios de Google y el componente GPS del dispositivo móvil mencionado anteriormente, se obtienen los datos de localización. En cambio, cuando no se encuentren en ellas, se les pedirá que introduzcan manualmente sus datos de residencia para mayor integridad en los datos, y es ahí que se utilizará el servicio presentado para resolver dicha cuestión.
\\

En cuanto al API de Google Maps, permite al desarrollador agregar un mapa basado en los datos de Google Maps en la pantalla de la aplicación e interactuar con él de la misma forma que se realiza en una computadora. El API controla automáticamente el acceso a los servidores de Google, la descarga de datos, visualización del mapa y respuestas \cite{maps}.
\\

Así como se permite la interacción del usuario con el mapa, pudiendo desplazarse, realizar zoom y cambiar la clase de mapa (normal, satélite o tierra), se permite agregar ciertos elementos dentro del mapa, como por ejemplo marcadores (markers), polilíneas, polígonos y superposiciones de mapas (overlays).
\\

En relación al proyecto, se aprovechan las facilidades ofrecidas por el API de Google Maps para la presentación de estadísticas interactivas. Todas aquellas encuestas geolocalizadas que hayan sido resueltas en al menos una oportunidad, brindarán una sección de estadísticas instantáneas para los ``Usuario Específicos''. Gracias a la latitud y longitud recopilada durante su resolución, es posible crear marcadores dentro de los mapas ubicando las respuestas de los usuarios. A simple vista las respuestas del mismo tipo serán agrupadas con marcadores del mismo color y dentro de la descripción en cada uno de ellos se presentará el sexo y edad del encuestado.

%------------------------------------------------------------------
\subsection{Librería MPAndroidChart}
%-------------------------------------------------------------------
\label{cap4:subsec:mpandroidchart}

MPAndroidChart es una librería que nos permite mostrar de forma fácil y personalizada grandes conjuntos de datos en formas gráficas \cite{mpandroidchart}. Permite además, arrastrar, escalados y animaciones en los gráficos, los cuales pueden ser de varios tipos, dependiendo de las necesidades y tipos de datos.
\\

Para realizar su integración con el proyecto Android, es necesario descargar la librería desde el repositorio oficial obteniendo un archivo \textit{.jar}. El mismo es añadido mediante la opción \textit{Add as Library} de Android Studio, y finalmente debe compilarse mediante su anotación en el \textit{build.gradle}.
\\

En relación al proyecto, dentro de la sección de estadísticas por encuesta brindada a los ``Usuario Específicos'', se preparan distintos gráficos para todas aquellas preguntas del tipo \textit{Múltiple Choice} o  \textit{Respuesta Única}, por ejemplo. De esta forma, nos permite conocer, analizar y comparar visual y rápidamente los distintos resultados obtenidos hasta el momento.

%------------------------------------------------------------------
\subsection{Librería OpenCsv}
%-------------------------------------------------------------------
\label{cap4:subsec:opencsv}

OpenCsv es una librería Java gratuita de parseos en CSV, tanto para lecturas como escrituras \cite{opencsv}. Los archivos CSV (comma-separated values) son un tipo de documento en formato abierto sencillo para representar datos en forma de tabla, en las cuales las columnas son separadas por comas (o punto y coma). 
\\

La librería ofrece principalmente las clases \textit{CSVReader} y \textit{CSVWriter}, las cuales dan operaciones para leer el fichero CSV como un arreglo de String o para escribir sobre uno de ellos, respectivamente. Tanto en la lectura como la escritura presentan las siguientes metodologías de parseo:

\begin{itemize}
	
	\item Desde y hacia un arreglo de Strings.
	
	\item Desde y hacia un Bean, mediante la clase \textit{CsvToBean} que realiza el parseo conforme a un \textit{MappingStrategy}, interfaz que define el mapeo entre los datos CSV y la clase Java.
	
	\item Desde una base de datos.
	
\end{itemize}

En este caso, gracias a las facilidades aportadas por OpenCsv, es posible llevar adelante la exportación de resultados para una determinada encuesta en el presente proyecto. Así como los ``Usuario Específicos'' pueden visualizar todas las estadíticas presentadas por cada encuesta, tienen disponible la opción de exportar resultados, la cual mediante la solicitud de un permiso extra para utilizar el almacenamiento interno del dispotivo móvil, guarda el archivo \textit{.csv} pudiendo ser accedido cuando se requiera. El mismo puede ser abierto con cualquier planilla de cálculos como por ejemplo Excel.

%-------------------------------------------------------------------
\section{Modelado de la aplicación}
%-------------------------------------------------------------------
\label{cap4:sec:modelado-aplicacion}

\begin{figure}[h!]
	\begin{center}
		\includegraphics[width=1\textwidth]%
		{Imagenes/Bitmap/modelo_aplicacion}
		\caption{Diagrama de clases de la aplicación}
		\label{fig:modelo-app}
	\end{center}
\end{figure}

En la Figura \ref{fig:modelo-app} se presenta el diagrama de clases que se encarga de modelar la aplicación Android, presentando en detalle cada uno de sus componentes.
\\

Se tiene una clase \textit{MainActivity} la cual Android escoge para manejar la actividad principal de la aplicación. Dicha clase se encarga de instanciar los métodos específicos correspondientes a las distintas funcionalidades que presenta el proyecto y de gestionar la identificación del usuario. Tal como se mencionó anteriormente, todos los ``Activities'' se encuentran embebidos dentro de éste Activity principal, lo cual permite la manipulación independiente de cada uno de ellos, teniendo su propio layout y ciclo de vida. 
\\

Inicialmente cabe aclarar que en la mayoria de las clases presentadas del modelo se encuentran atributos y funcionalidades similares, los cuales se explicarán a continuación. Dentro de los atributos, a modo de resumen se detalló como ``Fields \& Buttons'' a todos aquellos componentes gráficos que presenta el layout, para poder manipularlos individualmente y reaccionar ante determinados eventos sobre ellos. En cuanto a funcionalidades, las más utilizadas son las siguientes:

\begin{itemize}
	
	\item \textit{onCreate()}: es el primer método que se llama cuando se crea el Activity, donde se setea el layout (setContentView) correspondiente. Además se inicializan todos los componentes presentes en la vista y se pueden determinar reacciones ante determinados eventos sobre ellos.
	
	\item \textit{onBackPressed()}: vuelve al Activity anterior del que te encuentras en el momento. Dentro de este método se pueden configurar mensajes de alerta por ejemplo, para no perder los datos cargados en un retroceso involuntario. Es invocado por el botón ``Volver'' del dispositivo móvil y fue configurado para un botón propio de la aplicación ubicado en un \textit{toolbar} superior.
	
	\item \textit{onActivityResult()}: cuando se termina de utilizar un Activity y vuelve al anterior, el sistema llama este método. Dentro de él se puede definir como recuperar la información resultante de la actividad recientemente finalizada, el cual proporciona los parámetros necesarios para saber qué lanzó dicha actividad y el resultado (\textit{resultCode}), si es OK, CANCELED, etc.
	
	\item \textit{onSaveInstanceState()}: este método se encarga de guardar datos acerca del estado de un Activity. Por ejemplo, en la rotación de pantalla (cuando se gira el móvil de vertical a horizontal y viceversa), el sistema vuelve a crear la actividad haciendo que todos los datos presentados en un texto editable se pierdan. Por lo tanto este método los guarda y vuelve a crear correctamente.
	
\end{itemize}

El MainActivity se encuentra directamente relacionado con dos activities a tener en cuenta. El primero de ellos es el \textit{RegisterActivity}, el cual se encarga de llevar a cabo del registro de usuarios, y el \textit{MenuActivity} que presenta las funcionalidades principales de la aplicación, dependiendo el tipo de usuario que inició sesión. Dichas funcionalidades son:

\begin{itemize}
	
	\item \textit{AdminEncuestasActivity}: disponible solamente para un tipo de usuario, donde se podrá llevar a cabo toda la administración relacionada a las encuestas: alta, baja, modificación, habilitación e inhabilitación. A su vez se relaciona con \textit{CrearModificarEncuestaActivity}, el cual presenta toda la lógica para el alta y modificación de encuestas, con sus preguntas, respuestas, restricciones, etc.
	
	\item \textit{NoticiasActivity}: activity relacionado a la visualización y/o administración de noticias e informaciones, dependiendo el tipo de usuario logueado. Al igual que en las encuestas, se relaciona con \textit{CrearNoticiaActivity} para llevar adelante la lógica de creación de noticias.
	
	\item \textit{EncuestasActivity}: este activity presenta todas las encuestas que se encuentran disponibles para resolver y/o información extra de las mismas, dependiendo el tipo de usuario logueado. Se encuentra relacionado con \textit{ResolverActivity}, el cual se encarga de presentar la encuesta para resolverla e invocar los métodos necesarios para su persistencia. Este último Activity contiene distintos métodos que valen la pena ampliar, como \textit{verifyLocationPermission} que se encarga de solicitar los permisos para utilizar el componente GPS al usuario, \textit{getLocationServices} que recupera los datos relacionados al geoposicionamiento del usuario a la hora de resolver la encuestas, y \textit{openPlacePicker} que invoca el servicio de Google explicado anteriormente para seleccionar manualmente la localización.
	
	Para aquellos usuarios que poseen los permisos adecuados, dentro de EncuestaActivity podrán exportar los resultados de la encuesta mediante su relación con la clase \textit{ExportCSVTask} y con la solicitud de permisos para almacenamiento de \textit{verifyStoragePermissions}.
	
	Además, estos usuarios podrán ver estadísticas de cada encuesta resuelta, por lo tanto se encuentra relacionado con \textit{ResultadosActivity}, el cual posee los servicios correspondientes a la librería MPAndroidChart para visualizar gráficos y relacionado con \textit{ResultMapsActivity} que se encarga de distribuir visualmente los resultados en un GoogleMaps. 
	
\end{itemize}

Luego, como se puede ver en el modelo, la gran mayoría de los activities se encuentran relacionados con la clase \textit{HTTPAsyncTask}. Esta clase se encarga de la conexión a la red y de lanzar las distintas peticiones que se realizan sobre el Web Service. A la hora de ser invocado por un determinado Activity se tiene en cuenta que método invocar y el tipo de petición HTTP que se trata. 
\\

Finalmente, tal como fue mencionado anteriormente, se trabajará mediante JSONs para las distintas peticiones. Por lo tanto, se precisa de una clase \textit{JSONConverter} que realiza la conversión de objetos de dicho tipo (manipulados por la clase HTTPAsyncTask) en DTOS (Data transfer object), los cuales son objetos simples sin lógica de negocio, utilizados para representar los datos a nivel aplicación.

%-------------------------------------------------------------------
\section{Presentación de EncuestandoFCM}
%-------------------------------------------------------------------
\label{cap4:sec:presentacionapp}

En esta sección, se llevará a cabo la presentación de la aplicación móvil \textit{EncuestandoFCM}, junto a todas las funcionalidades y librerías mencionadas anteriormente, que se encargaron de complementar el producto final.

%------------------------------------------------------------------
\subsection{Login y registro de usuario}
%-------------------------------------------------------------------
\label{cap4:subsec:loginregistro}

Al instalar la aplicación y abrirla, se presentará hacia todos los usuarios una pantalla simple de logueo tal como se muestra en la Figura \ref{fig:login}. Si ya se posee un usuario creado, simplemente se debe ingresar el nombre, contraseña e \textit{Iniciar Sesión}. Se verificará consumiendo el servicio correspondiente en el WS si los datos ingresados son correctos y de esta forma redirigir a la pantalla principal adecuada (teniendo en cuenta el tipo de usuario del mismo), como ya se verá más adelante, caso contrario, se informarán los errores de logueo en la misma pantalla.
\\

Si no se posee un usuario para ingresar, se debe presionar sobre el botón \textit{Registrarse}, el cual va a redirigir hacia la pantalla de registro de usuario que se presenta en la Figura \ref{fig:registro}. Aquí se deben colocar todos los datos personales y para el caso de aquellos ``Usuarios de Medicina'', que serán los denominados anteriormente como ``Usuarios Específicos'', se debe tildar el checkbox correspondiente y luego ingresar el código de validación, el cual debe ser solicitado a un superior de la facultad de medicina para obtener las funcionalidades de dicho tipo de usuario.
\\

Al presionar guardar, inicialmente se verificará que todos los datos se encuentren cargados, ya que los mismos son de carácter obligatorio, caso contrario se informará. Una vez completados los mismos se envían al WS para su registro, éste devolverá un \textit{response} en formato JSON informando el éxito de la transacción o aquellos campos que se deben corregir. Por ejemplo: nombre de usuario o email ya en uso, password que no cumple la longitud, código de validación incorrecto, etc.

\begin{figure}[h!]
	\centering
	\subfloat[Pantalla de Login]{
		\label{fig:login}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/2_app.png}}
	\subfloat[Pantalla de Registro de Usuarios]{
		\label{fig:registro}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/3_app.png}}
	\caption{Login \& Registro}
	\label{fig:loginregistro}
\end{figure}

%------------------------------------------------------------------
\subsection{Menú principal}
%-------------------------------------------------------------------
\label{cap4:subsec:menuprincipal}

Como se mencionó anteriormente, al iniciar sesión se presenta un menú principal. Éste varía de acuerdo al tipo de usuario logueado. En el caso de los usuarios ``comunes'', como se muestra en la Figura \ref{fig:menunormal}, se tendrán las opciones de \textit{Encuestas Disponibles} e \textit{Información \& Noticias}. Como se verá más adelante, en ellas se podrán responder encuestas en una sola ocasión (siempre y cuando cumpla con las validaciones previas) y leer las noticias agregadas respectivamente. 
\\

Cuando los usuarios son del tipo ``específicos'', se presentará una pantalla como en la Figura \ref{fig:menuespecial}. Aquí se tienen las mismas opciones que el otro tipo de usuario, con la diferencia de que se pueden responder ilimitadamente las encuestas, ver estadísticas sobre las mismas, exportar resultados, realizar AMBs de Informaciones, etc. Además, se haya la opción de \textit{Administrar Encuestas}, para realizar los ABMs, habilitación e inhabilitación de ellas.

\begin{figure}[h!]
	\centering
	\subfloat[Menú principal Usuario común]{
		\label{fig:menunormal}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/4_app.png}}
	\subfloat[Menú principal Usuario Especial]{
		\label{fig:menuespecial}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/5_app.png}}
	\caption{Menú principal}
	\label{fig:menuprincipal}
\end{figure}

%------------------------------------------------------------------
\subsection{Sección noticias e informaciones (I\&N)}
%-------------------------------------------------------------------
\label{cap4:subsec:noticiasinfoseccion}

Esta sección fue pensada para que los usuarios de la aplicación además de responder las encuestas, puedan informarse e instruirse acerca de distintas enfermedades, epidemiologías, informaciones relevantes, etc. 
\\

Para aquellos usuarios comunes que ingresan a la sección, se presentará en un \textit{ListView} con un título y una breve descripción, las distintas I\&N cargadas en base de datos (Figura \ref{fig:infocomun}). Para ello, se consumirá el correspondiente endpoint del WS al cargar las mismas. Al presionar sobre una de ellas, se abrirá un \textit{WebView} sobre la misma aplicación, con el contenido de la URL correspondiente (Figura \ref{fig:ejemploinfol}).

\begin{figure}[h!]
	\centering
	\subfloat[I\&N U. común]{
		\label{fig:infocomun}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/6_app.png}}
	\subfloat[I\&N U. específico]{
		\label{fig:infoespeciall}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/7_app.png}}
	\subfloat[Alta de I\&N]{
		\label{fig:altainfol}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/8_app.png}}
	\subfloat[Ejemplo I\&N]{
		\label{fig:ejemploinfol}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/9_app.png}}
	\caption{Noticias e informaciones}
	\label{fig:noticiasinfo}
\end{figure}

Para aquellos usuarios de tipo específico, como se puede ver en la Figura \ref{fig:infoespeciall}, se presentan las distintas opciones de ABM. Se encuentra disponible un botón para agregar I\&N, el cual direcciona hacia la pantalla de alta (Figura \ref{fig:altainfol}). Aquí se debe colocar el título de la I\&N, una breve descripción informativa y la URL a la que apuntará la misma. Al presionar sobre un ítem de la \textit{ListView}, se abrirá un pop up que posee las opciones de eliminar y ver. Todas éstas opciones, consumen sus correspondientes servicios del WS para llevarlo a cabo.


%------------------------------------------------------------------
\subsection{Sección administrar encuestas}
%-------------------------------------------------------------------
\label{cap4:subsec:adminseccion}

Como se mencionó anteriormente, esta sección solamente estará disponible para aquellos usuarios de tipo específico. Al ingresar, se presentará un \textit{ListView} de las encuestas existentes (con \textit{activo = true}) traídas por WS. Cada ítem estará formado por un título y una descripción (Figura \ref{fig:listaencuestasadmin}). Como se puede ver en la actual pantalla y en subsiguientes, se presenta un icono de ayuda (arriba a la derecha), el cual despliega un pop up informativo acerca de todas las funcionalidades presentadas, con la finalidad de colaborar en la experiencia de usuario.
\\

Presionando sobre el botón rojo \textbf{(+)}, se direcciona hacia la pantalla de \textit{Nueva Encuesta} como se puede ver en la Figura \ref{fig:altaencuesta}. Aquí se deberá completar de carácter obligatorio el título y poseer al menos una pregunta. Luego se presentan una serie de validaciones opcionales en forma de \textit{CheckBox}. Por ejemplo, si se requiere que la encuesta sea \textit{Geolocalizada} se debe tildar el mismo. Esto significa que cuando se resuelva la misma se almacenará la latitud y longitud de los encuestados, a modo de poseer referencias zonales para posteriores análisis. A su vez, se pueden agregar restricciones sobre los encuestados, es decir que los mismos sean de un sexo determinado y/o mayores a determinada edad (Figura \ref{fig:validacionesl}). 

\begin{figure}[h!]
	\centering
	\subfloat[Lista Encuestas]{
		\label{fig:listaencuestasadmin}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/10_app.png}}
	\subfloat[Nueva Encuesta]{
		\label{fig:altaencuesta}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/11_app.png}}
	\subfloat[Tipos Respuestas]{
		\label{fig:tiporespuestasl}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/12_app.png}}
	\subfloat[Validaciones]{
		\label{fig:validacionesl}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/13_app.png}}
	\caption{Administración de encuestas}
	\label{fig:admin1}
\end{figure}

Para agregar preguntas a la encuesta, se debe presionar sobre el botón verde \textbf{(?)} (Figura \ref{fig:tiporespuestasl}). El mismo despliega una serie de opciones en relación al tipo de respuesta que tendrá y presionando sobre uno de ellos, se direccionará a la correspondiente alta.
\\

Para aquellas preguntas que tendrán una serie de respuestas predefinidas, como por ejemplo las \textit{Múltiple Choice} y \textit{Respuesta Única}, se presenta un campo editable para ingresar la pregunta y un botón que despliega un pop up para ir ingresando las respuestas (Figura \ref{fig:choice} y \ref{fig:unicarta}). Luego, al presionar sobre cada respuesta se presentará un \textit{AlertDialog} (Figura \ref{fig:opcionesrtas}) que permite modificar o eliminar la misma.

\begin{figure}[h!]
	\centering
	\subfloat[Múltiple Choice]{
		\label{fig:choice}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/14_app.png}}
	\subfloat[Respuesta Única]{
		\label{fig:unicarta}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/15_app.png}}
	\subfloat[Opciones sobre respuesta]{
		\label{fig:opcionesrtas}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/16_app.png}}
	\caption{Alta y modificación de encuesta}
	\label{fig:admin2}
\end{figure}

Para aquellas preguntas que poseen una respuesta de tipo \textit{Numérica} o \textit{Textual}, el formato de alta es similar, donde el mismo presenta un campo editable para ingresar la pregunta en cuestión (Figura \ref{fig:numericas} y \ref{fig:textual}). La diferencia entre ellas, es visible a la hora de responder la encuesta, ya que el teclado solamente habilitará los caracteres numéricos o alfanuméricos respectivamente.

\begin{figure}[h!]
	\centering
	\subfloat[Numéricas]{
		\label{fig:numericas}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/17_app.png}}
	\subfloat[Textual]{
		\label{fig:textual}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/18_app.png}}
	\subfloat[Escala]{
		\label{fig:escala}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/19_app.png}}
	\subfloat[Valores Escala]{
		\label{fig:valoresescala}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/20_app.png}}
	\caption{Tipos de preguntas}
	\label{fig:admin3}
\end{figure}

En el caso de las preguntas con tipo de respuesta \textit{Escala}, además de ingresar la pregunta en cuestión en el campo editable, posee otro campo que despliega un \textit{NumberPicker}, eligiendo de ésta forma la escala máxima a responder, partiendo desde el 1 (Figura \ref{fig:escala} y \ref{fig:valoresescala}).
\\

Al ir agregando las preguntas como se mencionó anteriormente, aparecerán en la pantalla de nueva encuesta con su formato correspondiente, dependiendo del tipo de respuesta que contengan (Figura \ref{fig:altaencuesta} y \ref{fig:validacionesl}). Finalmente al presionar \textit{Agregar}, se validará que todos los datos ingresados sean correctos y se procederá a persistir en base de datos consumiendo el WS, caso contrario se informarán los errores para corregirlos.
\\

Nuevamente sobre la pantalla de \textit{Administración de Encuestas}, como se presentó en la Figura \ref{fig:listaencuestasadmin}, al presionar sobre un ítem específico se desplegará en un pop up las diferentes opciones a realizar, que se describirán a continuación:

\begin{itemize}
	
	\item \textbf{\textit{Eliminar}}: procede a realizar una ``baja lógica'' de la encuesta. Es decir, la misma no será eliminada de la base de datos, sino que modificará los campos correspondientes para no ser cargada en la aplicación, es decir se colocará como \textit{false} el campo ``activo'' y se completarán los campos ``usuario de baja'' y ``fecha de baja''. Ésta metodología fue desarrollada a fin de tener una auditoría de la base de datos y mayor control sobre la misma.
	
	\item \textbf{\textit{Modificar}}: esta opción solamente estará visible para aquellas encuestas que aún no han sido resueltas. Se determinó esta metodología, para mantener integridad en los datos y no obtener resultados incorrectos o desactualizados. Al presionar sobre ésta opción, se abrirá una pantalla similar a la Figura \ref{fig:altaencuesta}, con todos los datos cargados correctamente, pudiendo eliminar, modificar o agregar preguntas y respuestas, cambiar validaciones, etc.
	
	\item \textbf{\textit{Habilitar}}: al crear una encuesta, la misma queda en estado activa pero pendiente de habilitación. Es decir, para que ella quede disponible para responder, previamente debe ser habilitada. Esta metodología está relacionada con la opción de modificar, ya que evitando que una encuesta quede automáticamente disponible de resolución, la misma puede modificarse cuantas veces quiera y cuando se considere que la misma está acorde para responderse, así habilitarla y empezar a recabar resultados.
	
	\item \textbf{\textit{Inhabilitar}}: cuando se considere que una encuesta quedó desactualizada o no se necesiten más resultados de la misma, simplemente se inhabilita, haciendo que su resolución ya no esté más disponible en la correspondiente sección.
	
\end{itemize}

%------------------------------------------------------------------
\subsection{Sección encuestas disponibles}
%-------------------------------------------------------------------
\label{cap4:subsec:encuestasseccion}

Al ingresar a la opción de encuestas disponibles desde el menú principal, se direcciona hacia una pantalla que presenta una lista de las mismas con una vista de tipo \textit{RecyclerView} por item. Como se mencionó anteriormente, aquí se cargarán todas aquellas encuestas que se encuentren en estado \textbf{activas} y \textbf{habilitadas}. Para ambos tipos de usuarios cada Recycler está compuesto por el título de la encuesta, descripción, una etiqueta que solamente será visible en encuestas geolocalizadas y las restricciones de resolución en caso de tenerlas. Únicamente para los usuarios de tipo especial se presentará un \textit{TextView} que indicará el usuario creador y fecha, y otro indicando el número actual de resoluciones (Figura \ref{fig:encuestaespecial} y \ref{fig:encuestacomun}).
\\

Al presionar sobre un ítem para responder se abrirá una pantalla con todos los datos de la encuesta. Si la misma tiene la característica de ser geolocalizada, previamente se le solicitarán los permisos al usuario para utilizar la ubicación del dispositivo (Figura \ref{fig:permisosubicacion}). Éstos permisos serán requeridos solamente una vez en caso de aceptarse.
\\

Cuando es resuelta por un usuario especial, al comienzo se presenta un campo para indicar la edad del encuestado y otro para indicar el sexo del mismo (Figura \ref{fig:resolucionencuesta}). Esto es para las denominadas ``salidas a terreno'', cuando se encuesta a terceros. Para el caso de resolución en usuarios comunes, éstos campos no estarán presentes, ya que se obtendrán automáticamente desde el inicio de sesión.

\begin{figure}[h!]
	\centering
	\subfloat[Encuestas especial]{
		\label{fig:encuestaespecial}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/21_app.png}}
	\subfloat[Encuestas común]{
		\label{fig:encuestacomun}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/22_app.png}}
	\subfloat[Permisos ubicación]{
		\label{fig:permisosubicacion}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/23_app.png}}
	\subfloat[Resolución]{
		\label{fig:resolucionencuesta}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/24_app.png}}
	\caption{Encuestas disponibles de resolución}
	\label{fig:seccionencuestas1}
\end{figure}

Luego por cada pregunta a responder, se presentará una vista diferente dependiendo del tipo de respuesta de la misma, es decir:

\begin{itemize}
	
	\item \textbf{\textit{Múltiple Choice}}: respuestas como \textit{Checkbox} pudiendo escoger una o más.
	
	\item \textbf{\textit{Respuestas Únicas}}: respuestas como \textit{RadioButton} pudiendo escoger solamente una.
	
	\item \textbf{\textit{Numéricas}}: teclado numérico disponible, plasmando la respuesta en un campo editable.
	
	\item \textbf{\textit{Textuales}}: teclado alfanumérico libre de desarrollo, plasmando la respuesta en un campo editable.
	
	\item \textbf{\textit{Escala}}: la respuesta debe ser elegida sobre un \textit{NumberPicker} que presenta las escalas disponibles.
	
\end{itemize}

Al finalizar la resolución si la misma no fuera de carácter geolocalizada, simplemente se presiona enviar y se evaluará que todos los ítems hayan sido respondidos y no queden campos sin completar. Si hubiere algún tipo de error, se presentará en pantalla, caso contrario se almacenarán las respuestas en base de datos, consumiendo el correspondiente servicio del WS. 
\\

Para el caso de aquellas encuestas de tipo \textbf{geolocalizadas}, se encontrará visible al final de la encuesta un checkbox para definir el lugar de residencia (Figura \ref{fig:envioresolucion}). Con el fin de obtener correctos datos de geolocalización sobre los usuarios encuestados, se les pregunta si al responder la encuesta se encuentran en su residencia habitual. Al tildar el checkbox y presionar enviar, se validarán que todos los datos sean correctos y se obtendrá la ubicación del encuestado (latitud y longitud) gracias a la funcionalidad de \textit{LocationServices} de Google. En el caso de no tener activada la ubicación del dispositivo móvil o no haber aceptado los permisos para utilizarla (Figura \ref{fig:permisosubicacion}), se informará al usuario como error y no se podrá responder la encuesta hasta realizar las habilitaciones correspondientes.
\\

Si el usuario no se encuentra en su residencia habitual (checkbox sin tildar), se abrirá un \textit{PlacePicker} (Figura \ref{fig:eleccionresidencia}), herramienta obtenida mediante la integración con el API de Google Maps, en donde se puede ingresar la dirección de residencia en la parte superior y luego buscar, o ir moviendo el \textit{marker} para obtener la ubicación correspondiente. Finalmente, al presionar ``Seleccionar ésta ubicación'', se mostrará un mensaje de comprobación (Figura \ref{fig:placepickerapp}) en donde se visualizará con mayor precisión la dirección escogida pudiendo volver a elegirla o confirmarla, invocando luego los servicios del WS para almacenar los resultados en base de datos.

\begin{figure}[h!]
	\centering
	\subfloat[Envío de Resolución]{
		\label{fig:envioresolucion}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/25_app.png}}
	\subfloat[Elección de residencia]{
		\label{fig:eleccionresidencia}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/26_app.png}}
	\subfloat[Place Picker]{
		\label{fig:placepickerapp}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/27_app.png}}
	\caption{Resolución de encuestas}
	\label{fig:seccionencuestas2}
\end{figure}

Para aquellos usuarios de tipo especial, todas aquellas restricciones escogidas inicialmente en la creación de las encuestas no serán tenidas en cuenta, así como también poder resolver las mismas de manera ilimitada. En cambio, para los usuarios comunes al momento de querer responder una encuesta, se tendrá en cuenta que cumpla con los requisitos y su resolución solamente estará disponible en una ocasión. En el caso de presentarse algún inconveniente se informará y no se dejará resolver, como se puede ver en la Figura \ref{fig:erroresvalidaciones}.

\begin{figure}[h!]
	\centering
	\subfloat[Error de edad]{
		\label{fig:error1}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/28_app.png}}
	\subfloat[Error de sexo]{
		\label{fig:error2}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/29_app.png}}
	\subfloat[Encuesta ya resuelta]{
		\label{fig:error3}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/30_app.png}}
	\caption{Resolución de encuestas}
	\label{fig:erroresvalidaciones}
\end{figure}

%------------------------------------------------------------------
\subsection{Evaluación de resultados}
%-------------------------------------------------------------------
\label{cap4:subsec:evaluacionresultados}

Con la finalidad de obtener resultados y estadísticas de manera inmediata, dentro del menú de encuestas disponibles, para los usuarios especiales se colocaron dos opciones extras (además de responder) al presionar sobre un ítem como se puede ver en la Figura \ref{fig:opcionesresultados}. Las mismas son: ver estadísticas de los resultados y exportar los mismos a un formato Excel.

\begin{figure}[h!]
	\centering
	\subfloat{
		\label{fig:opciones}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/31_app.png}}
	\caption{Opciones sobre una encuesta}
	\label{fig:opcionesresultados}
\end{figure}

Al presionar sobre la opción ``Ver estadísticas'', se cargará la encuesta donde se presentará el título y descripción de la misma, seguidos de un promedio de edad y sexo de los encuestados hasta el momento (Figura \ref{fig:estadistica1}).
\\

Una vez más, dependiendo del tipo de respuesta por cada pregunta, se renderizará la vista de manera distinta (Figura \ref{fig:estadistica2} y \ref{fig:estadistica3}):

\begin{itemize}
	
	\item \textbf{\textit{Múltiple Choice}}: el promedio de resultados se presentará en gráficos de torta.
	
	\item \textbf{\textit{Respuestas Únicas}}: el porcentaje de respuestas será presentado en gráficos de barras.
	
	\item \textbf{\textit{Numéricas}}: se presentará el número promedio escogido por los encuestados en un \textit{TextView} circular.
	
	\item \textbf{\textit{Textuales}}: no presentarán estadística alguna, ya que al ser de libre desarrollo su análisis va más allá de resultados promediables.
	
	\item \textbf{\textit{Escala}}: se presentará el número promedio escogido por los encuestados en relación a la máxima escala posible en un \textit{TextView} circular.
	
\end{itemize}

A su vez, presionando sobre una determinada respuesta, se mostrarán los resultados geolocalizados en caso de ser una encuesta de dicho tipo, mediante la integración con el API de Google Maps. Se distribuirán las respuestas en \textit{Google Maps} gracias a la latitud y longitud almacenada en base de datos, clasificando por colores aquellas respuestas iguales en el caso de Múltiple Choice y Respuestas Únicas. Además, presionando sobre los marcadores se presentará una breve descripción que indicará la respuesta, sexo y edad del encuestado (Figura \ref{fig:resultadosgeo}).

\begin{figure}[h!]
	\centering
	\subfloat[Estadísticas]{
		\label{fig:estadistica1}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/32_app.png}}
	\subfloat[Estadísticas]{
		\label{fig:estadistica2}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/33_app.png}}
	\subfloat[Estadísticas]{
		\label{fig:estadistica3}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/34_app.png}}
	\subfloat[Resultados Geolocalizados]{
		\label{fig:resultadosgeo}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/35_app.png}}
	\caption{Visualización de resultados}
	\label{fig:estadisticasencuestas}
\end{figure}

Por otro lado, si se escoge la opción de ``Exportar Resultados'', se le solicitará previamente al usuario aceptar los permisos de almacenamiento (Figura \ref{fig:permisosalmacenamiento}). En caso de rechazarlos, se denegará la exportación informando al usuario de la misma manera que con los permisos de ubicación. Al aceptarlos, se procederá a convertir los datos a un formato Excel gracias a la librería de \textit{OpenCSV}. Los mismos estarán disponibles para su posterior estudio por profesionales adecuados de la medicina, así como también bio-estadísticos. 
\\

La conversión de datos se realizará de manera asíncrona, es decir, en segundo plano para no entorpecer el funcionamiento normal de la aplicación. Es por ello, que puede tardar algunos segundos en producirse, para luego estar disponible dentro de las descargas del dispositivo móvil. En el archivo Excel se encuentran los datos principales de la encuesta como el título y descripción, y por cada pregunta se listan las respuestas obtenidas hasta el momento, con el sexo y edad del encuestado, latitud y longitud, etc (Figura \ref{fig:exportarapp}).

\begin{figure}[h!]
	\centering
	\subfloat[Solicitud permisos almacenamiento]{
		\label{fig:permisosalmacenamiento}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/36_app.png}}
	\subfloat[Resultados exportados]{
		\label{fig:exportarapp}
		\includegraphics[width=0.25\textwidth]{Imagenes/Bitmap/37_app.png}}
	\caption{Exportar resultados}
	\label{fig:exportar}
\end{figure}

\newpage
\thispagestyle{empty}
\mbox{ }